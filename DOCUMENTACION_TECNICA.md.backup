# ğŸ“˜ DOCUMENTACIÃ“N TÃ‰CNICA - Sistema de GestiÃ³n ClÃ­nica Dental
## ğŸ“ GUÃA PARA PRINCIPIANTES TOTALES

**Proyecto:** Taller2 - Sistema Web de ClÃ­nica Dental  
**TecnologÃ­as:** Java 11, Jakarta EE 9, PostgreSQL, GlassFish 6.2.5  
**Fecha:** Noviembre 2025  
**Nivel de ExplicaciÃ³n:** ğŸ¼ Para bebÃ©s en programaciÃ³n (pero ustedes son bebÃ©s inteligentes ğŸ˜)

---

## ğŸ“š TABLA DE CONTENIDOS

1. [Â¿QuÃ© demonios es este proyecto?](#quÃ©-es-este-proyecto)
2. [Arquitectura General (Â¿CÃ³mo estÃ¡ organizado esto?)](#arquitectura-general)
3. [PatrÃ³n Singleton - ConexiÃ³n a Base de Datos (Â¿Por quÃ© una sola conexiÃ³n?)](#patrÃ³n-singleton)
4. [PatrÃ³n DAO - Data Access Object (Â¿CÃ³mo hablamos con la BD?)](#patrÃ³n-dao)
5. [Servlets - Los Controladores (Â¿QuÃ© son estos bichos?)](#servlets)
6. [Sistema de AutenticaciÃ³n (Login, Registro, Recuperar ContraseÃ±a)](#sistema-autenticaciÃ³n)
7. [Sistema de Turnos y Comentarios (Â¿CÃ³mo funcionan?)](#turnos-comentarios)
8. [Panel de AdministraciÃ³n (El poder total)](#panel-admin)
9. [Control de Acceso para Invitados (Â¿Por quÃ© los invitados no pueden hacer nada?)](#control-invitados)
10. [Carruseles y JavaScript (Las animaciones chulas)](#carruseles)
11. [Flujo de Datos Completo (De principio a fin)](#flujo-datos)
12. [Problemas Comunes y Soluciones](#problemas-comunes)

---

## ğŸ¤” Â¿QUÃ‰ DEMONIOS ES ESTE PROYECTO? {#quÃ©-es-este-proyecto}

### Imagina que tu abuela te pregunta: "Â¿QuÃ© estÃ¡s haciendo?"

**Respuesta corta:** Estamos haciendo un sitio web para una clÃ­nica dental donde las personas pueden:
- Ver informaciÃ³n de la clÃ­nica
- Pedir citas (turnos)
- Dejar comentarios
- Los administradores pueden gestionar todo

### AnalogÃ­a del Mundo Real ğŸŒ

Piensa en tu clÃ­nica dental favorita. Ahora imagina que:
- **Antes:** TenÃ­as que llamar por telÃ©fono para pedir cita (antiguo y aburrido)
- **Ahora:** Entras al sitio web, rellenas un formulario, y Â¡listo! (moderno y cool)

### Â¿QuÃ© hace diferente a ESTE proyecto?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USUARIO (tÃº, navegando desde Chrome)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ "Quiero pedir una cita"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NAVEGADOR envÃ­a peticiÃ³n HTTP              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GLASSFISH (el servidor que escucha)        â”‚
â”‚  "Ah, quieres pedir cita, dÃ©jame ver..."    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVLET (PedirTurnoServlet.java)           â”‚
â”‚  "Ok, voy a verificar si estÃ¡s logueado"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DAO (TurnoDAO.java)                        â”‚
â”‚  "Voy a guardar esta cita en la BD"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POSTGRESQL (Base de Datos)                 â”‚
â”‚  "Guardado. ID de turno: 123"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RESPUESTA AL USUARIO                       â”‚
â”‚  "Â¡Turno solicitado exitosamente! âœ“"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**TL;DR (Too Long; Didn't Read):**
Es un sitio web que conecta:
- **Frontend (JSP)** = Lo que ves (HTML, CSS, JavaScript)
- **Backend (Servlets)** = La lÃ³gica (Java)
- **Base de Datos (PostgreSQL)** = Donde se guarda todo

---

## ğŸ—ï¸ ARQUITECTURA GENERAL {#arquitectura-general}

---

## ğŸ—ï¸ ARQUITECTURA GENERAL {#arquitectura-general}

### Estructura del Proyecto

```
Taller2/
â”œâ”€â”€ src/main/java/com/taller2/
â”‚   â”œâ”€â”€ controller/          # Servlets (Controladores)
â”‚   â”‚   â”œâ”€â”€ LoginServlet.java
â”‚   â”‚   â”œâ”€â”€ RegistroServlet.java
â”‚   â”‚   â”œâ”€â”€ RecuperarContrasenaServlet.java
â”‚   â”‚   â”œâ”€â”€ PedirTurnoServlet.java
â”‚   â”‚   â”œâ”€â”€ ComentarioServlet.java
â”‚   â”‚   â”œâ”€â”€ PanelGestionServlet.java
â”‚   â”‚   â””â”€â”€ PanelAccionServlet.java
â”‚   â”‚
â”‚   â”œâ”€â”€ dao/                 # Data Access Objects
â”‚   â”‚   â”œâ”€â”€ BaseDAO.java
â”‚   â”‚   â”œâ”€â”€ UsuarioDAO.java
â”‚   â”‚   â”œâ”€â”€ TurnoDAO.java
â”‚   â”‚   â””â”€â”€ ComentarioDAO.java
â”‚   â”‚
â”‚   â”œâ”€â”€ model/               # Modelos (POJOs)
â”‚   â”‚   â”œâ”€â”€ Usuario.java
â”‚   â”‚   â”œâ”€â”€ Turno.java
â”‚   â”‚   â””â”€â”€ Comentario.java
â”‚   â”‚
â”‚   â””â”€â”€ util/                # Utilidades
â”‚       â””â”€â”€ DatabaseConnection.java (Singleton)
â”‚
â””â”€â”€ src/main/webapp/
    â”œâ”€â”€ WEB-INF/
    â”‚   â”œâ”€â”€ views/           # JSP Views
    â”‚   â”‚   â”œâ”€â”€ login.jsp
    â”‚   â”‚   â”œâ”€â”€ registro.jsp
    â”‚   â”‚   â”œâ”€â”€ recuperar.jsp
    â”‚   â”‚   â”œâ”€â”€ inicio.jsp
    â”‚   â”‚   â”œâ”€â”€ contacto.jsp
    â”‚   â”‚   â”œâ”€â”€ pedirTurno.jsp
    â”‚   â”‚   â””â”€â”€ panel.jsp
    â”‚   â””â”€â”€ web.xml          # ConfiguraciÃ³n Web
    â””â”€â”€ img/                 # Recursos estÃ¡ticos
```

### Arquitectura Multicapa

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CAPA DE PRESENTACIÃ“N (JSP)          â”‚
â”‚  - login.jsp, inicio.jsp, panel.jsp         â”‚
â”‚  - HTML + CSS inline + JavaScript           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP Request/Response
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       CAPA DE CONTROLADORES (Servlets)      â”‚
â”‚  - LoginServlet, PanelGestionServlet        â”‚
â”‚  - Validan datos, gestionan sesiones        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Invoca mÃ©todos
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CAPA DE ACCESO A DATOS (DAO)        â”‚
â”‚  - UsuarioDAO, TurnoDAO, ComentarioDAO      â”‚
â”‚  - Ejecutan SQL, mapean ResultSet           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Obtiene Connection
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CAPA DE UTILIDADES (Singleton)         â”‚
â”‚  - DatabaseConnection (Pool de conexiones)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ JDBC Driver
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         BASE DE DATOS (PostgreSQL)          â”‚
â”‚  - Tablas: usuarios, turnos, comentarios   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” PATRÃ“N DE DISEÃ‘O SINGLETON - CONEXIÃ“N A BASE DE DATOS {#patrÃ³n-singleton}

### Â¿QuÃ© es el PatrÃ³n Singleton?

El **Singleton** es un patrÃ³n de diseÃ±o creacional que garantiza que una clase tenga **una Ãºnica instancia** y proporciona un punto de acceso global a ella.

### Â¿Por quÃ© usamos Singleton para la conexiÃ³n a la BD?

1. **Evitar mÃºltiples conexiones innecesarias**: Crear una conexiÃ³n a la base de datos es costoso en recursos
2. **Pool de conexiones centralizado**: Una Ãºnica instancia gestiona todas las conexiones
3. **Acceso global**: Todos los DAOs pueden acceder a la misma instancia
4. **Thread-safe**: Garantiza seguridad en aplicaciones con mÃºltiples hilos

### ImplementaciÃ³n: `DatabaseConnection.java`

```java
package com.taller2.util;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

public class DatabaseConnection {
    
    // 1. INSTANCIA ÃšNICA (privada y estÃ¡tica)
    private static DatabaseConnection instance;
    
    // 2. CONFIGURACIÃ“N DE LA BASE DE DATOS
    private static final String URL = "jdbc:postgresql://localhost:5432/taller2_bd";
    private static final String USER = "postgres";
    private static final String PASSWORD = "postgres";
    
    // 3. CONSTRUCTOR PRIVADO (nadie puede hacer 'new DatabaseConnection()')
    private DatabaseConnection() {
        try {
            // Cargar el driver de PostgreSQL
            Class.forName("org.postgresql.Driver");
        } catch (ClassNotFoundException e) {
            throw new RuntimeException("Error al cargar el driver de PostgreSQL", e);
        }
    }
    
    // 4. MÃ‰TODO PÃšBLICO PARA OBTENER LA INSTANCIA ÃšNICA
    public static DatabaseConnection getInstance() {
        if (instance == null) {
            // Double-check locking para thread-safety
            synchronized (DatabaseConnection.class) {
                if (instance == null) {
                    instance = new DatabaseConnection();
                }
            }
        }
        return instance;
    }
    
    // 5. MÃ‰TODO PARA OBTENER UNA CONEXIÃ“N A LA BD
    public Connection getConnection() throws SQLException {
        return DriverManager.getConnection(URL, USER, PASSWORD);
    }
}
```

### Flujo de Uso del Singleton

```
1. Primera llamada desde UsuarioDAO:
   DatabaseConnection.getInstance().getConnection()
   â†“
   - instance == null â†’ Se crea la instancia
   - Constructor privado carga el driver
   - Retorna nueva conexiÃ³n

2. Segunda llamada desde TurnoDAO:
   DatabaseConnection.getInstance().getConnection()
   â†“
   - instance != null â†’ Reutiliza la misma instancia
   - Retorna nueva conexiÃ³n (pero misma instancia)

3. N llamadas posteriores:
   - Siempre usan la MISMA instancia de DatabaseConnection
   - Cada getConnection() crea una nueva Connection (del pool)
```

### Ventajas en Nuestro Proyecto

- âœ… **Una sola carga del driver PostgreSQL** (en el constructor)
- âœ… **ConfiguraciÃ³n centralizada** (URL, USER, PASSWORD en un solo lugar)
- âœ… **FÃ¡cil de cambiar** (si cambiamos de BD, solo modificamos esta clase)
- âœ… **Thread-safe** (mÃºltiples servlets pueden usarla simultÃ¡neamente)

---

## ğŸ“¦ PATRÃ“N DAO (DATA ACCESS OBJECT) {#patrÃ³n-dao}

### Â¿QuÃ© es un DAO?

**DAO** es un patrÃ³n de diseÃ±o que **encapsula toda la lÃ³gica de acceso a datos**, separando la lÃ³gica de negocio de la persistencia.

### Estructura de un DAO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          <<interface>>              â”‚
â”‚            BaseDAO                  â”‚
â”‚  + crear(T): boolean                â”‚
â”‚  + obtenerTodos(): List<T>          â”‚
â”‚  + actualizar(T): boolean           â”‚
â”‚  + eliminar(int): boolean           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ UsuarioDAO â”‚      â”‚  TurnoDAO   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ejemplo Completo: `UsuarioDAO.java`

```java
package com.taller2.dao;

import com.taller2.model.Usuario;
import com.taller2.util.DatabaseConnection;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class UsuarioDAO {
    
    // ========================================
    // 1. MÃ‰TODO: AUTENTICAR USUARIO
    // ========================================
    public Usuario autenticar(String usuario, String contrasena) {
        String sql = "SELECT * FROM usuarios WHERE usuario = ? AND contrasena = ?";
        
        // Try-with-resources: cierra automÃ¡ticamente Connection, PreparedStatement, ResultSet
        try (Connection conn = DatabaseConnection.getInstance().getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            // Establecer parÃ¡metros (previene SQL Injection)
            stmt.setString(1, usuario);
            stmt.setString(2, contrasena);
            
            // Ejecutar consulta
            ResultSet rs = stmt.executeQuery();
            
            // Si hay resultado, mapear a objeto Usuario
            if (rs.next()) {
                return mapearUsuario(rs);
            }
            
        } catch (SQLException e) {
            e.printStackTrace();
        }
        
        return null; // Usuario no encontrado o error
    }
    
    // ========================================
    // 2. MÃ‰TODO: OBTENER TODOS LOS USUARIOS
    // ========================================
    public List<Usuario> obtenerTodos() {
        List<Usuario> usuarios = new ArrayList<>();
        String sql = "SELECT * FROM usuarios ORDER BY id";
        
        try (Connection conn = DatabaseConnection.getInstance().getConnection();
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {
            
            while (rs.next()) {
                usuarios.add(mapearUsuario(rs));
            }
            
        } catch (SQLException e) {
            e.printStackTrace();
        }
        
        return usuarios;
    }
    
    // ========================================
    // 3. MÃ‰TODO: CREAR NUEVO USUARIO
    // ========================================
    public boolean crear(Usuario usuario) {
        String sql = "INSERT INTO usuarios (usuario, contrasena, rol, nombre_completo, email) " +
                     "VALUES (?, ?, ?, ?, ?)";
        
        try (Connection conn = DatabaseConnection.getInstance().getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            stmt.setString(1, usuario.getUsuario());
            stmt.setString(2, usuario.getContrasena());
            stmt.setString(3, usuario.getRol());
            stmt.setString(4, usuario.getNombreCompleto());
            stmt.setString(5, usuario.getEmail());
            
            // executeUpdate() retorna nÃºmero de filas afectadas
            return stmt.executeUpdate() > 0;
            
        } catch (SQLException e) {
            e.printStackTrace();
        }
        
        return false;
    }
    
    // ========================================
    // 4. MÃ‰TODO: BUSCAR POR NOMBRE DE USUARIO
    // ========================================
    public Usuario buscarPorNombreUsuario(String nombreUsuario) {
        String sql = "SELECT * FROM usuarios WHERE usuario = ?";
        
        try (Connection conn = DatabaseConnection.getInstance().getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            stmt.setString(1, nombreUsuario);
            ResultSet rs = stmt.executeQuery();
            
            if (rs.next()) {
                return mapearUsuario(rs);
            }
            
        } catch (SQLException e) {
            e.printStackTrace();
        }
        
        return null;
    }
    
    // ========================================
    // 5. MÃ‰TODO: CAMBIAR CONTRASEÃ‘A
    // ========================================
    public boolean cambiarContrasena(int usuarioId, String nuevaContrasena) {
        String sql = "UPDATE usuarios SET contrasena = ? WHERE id = ?";
        
        try (Connection conn = DatabaseConnection.getInstance().getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            stmt.setString(1, nuevaContrasena);
            stmt.setInt(2, usuarioId);
            
            return stmt.executeUpdate() > 0;
            
        } catch (SQLException e) {
            e.printStackTrace();
        }
        
        return false;
    }
    
    // ========================================
    // 6. MÃ‰TODO PRIVADO: MAPEAR ResultSet â†’ Usuario
    // ========================================
    private Usuario mapearUsuario(ResultSet rs) throws SQLException {
        Usuario usuario = new Usuario();
        usuario.setId(rs.getInt("id"));
        usuario.setUsuario(rs.getString("usuario"));
        usuario.setContrasena(rs.getString("contrasena"));
        usuario.setRol(rs.getString("rol"));
        usuario.setNombreCompleto(rs.getString("nombre_completo"));
        usuario.setEmail(rs.getString("email"));
        usuario.setFechaCreacion(rs.getTimestamp("fecha_creacion"));
        usuario.setActivo(rs.getBoolean("activo"));
        return usuario;
    }
}
```

### Â¿Por quÃ© usar DAOs?

| Ventaja | ExplicaciÃ³n |
|---------|-------------|
| **SeparaciÃ³n de Responsabilidades** | Los Servlets no tienen SQL, los DAOs no tienen lÃ³gica de negocio |
| **ReutilizaciÃ³n** | `usuarioDAO.obtenerTodos()` se usa en mÃºltiples servlets |
| **Mantenibilidad** | Si cambia la BD, solo modificamos los DAOs |
| **Testeable** | Podemos hacer tests unitarios de los DAOs por separado |
| **PrevenciÃ³n de SQL Injection** | Uso de PreparedStatement con parÃ¡metros |

---

## ğŸŒ SERVLETS Y CONTROL DE FLUJO {#servlets}

### Â¿QuÃ© es un Servlet?

Un **Servlet** es una clase Java que **maneja peticiones HTTP** y genera respuestas dinÃ¡micas. Funciona como **controlador** en el patrÃ³n MVC.

### Ciclo de Vida de un Servlet

```
1. INICIO DEL SERVIDOR (GlassFish)
   â†“
   init() â†’ Se ejecuta UNA VEZ al cargar el servlet
   â†“
2. PETICIÃ“N HTTP (Usuario navega a /login)
   â†“
   service() â†’ Decide si llamar a doGet() o doPost()
   â†“
   doGet() o doPost() â†’ Procesa la peticiÃ³n
   â†“
3. RESPUESTA HTTP (Redirige a /inicio o muestra error)
   â†“
4. FIN DEL SERVIDOR
   â†“
   destroy() â†’ Se ejecuta UNA VEZ al apagar el servidor
```

### Ejemplo Completo: `LoginServlet.java`

```java
package com.taller2.controller;

import com.taller2.dao.UsuarioDAO;
import com.taller2.model.Usuario;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import java.io.IOException;

// ========================================
// ANOTACIÃ“N: Define la URL del servlet
// ========================================
@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    
    // DAO para acceso a datos de usuarios
    private UsuarioDAO usuarioDAO;
    
    // ========================================
    // 1. INIT: Se ejecuta AL INICIAR el servlet
    // ========================================
    @Override
    public void init() {
        usuarioDAO = new UsuarioDAO();
    }
    
    // ========================================
    // 2. doGET: Muestra el formulario de login
    // ========================================
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        // Forward a la vista JSP
        request.getRequestDispatcher("/WEB-INF/views/login.jsp").forward(request, response);
    }
    
    // ========================================
    // 3. doPOST: Procesa el formulario enviado
    // ========================================
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // Obtener parÃ¡metros del formulario
        String usuario = request.getParameter("usuario");
        String contrasena = request.getParameter("contrasena");
        String tipoLogin = request.getParameter("tipoLogin");
        
        // Obtener sesiÃ³n actual (o crear una nueva)
        HttpSession session = request.getSession();
        
        // ========================================
        // CASO 1: Login como INVITADO
        // ========================================
        if ("invitado".equals(tipoLogin)) {
            session.setAttribute("tipoUsuario", "INVITADO");
            session.setAttribute("nombreUsuario", "Invitado");
            response.sendRedirect(request.getContextPath() + "/inicio");
            return;
        }
        
        // ========================================
        // CASO 2: Login con CREDENCIALES
        // ========================================
        if (usuario != null && contrasena != null) {
            // Llamar al DAO para autenticar
            Usuario user = usuarioDAO.autenticar(usuario, contrasena);
            
            if (user != null) {
                // âœ… AUTENTICACIÃ“N EXITOSA
                session.setAttribute("usuarioId", user.getId());
                session.setAttribute("usuario", user.getUsuario());
                session.setAttribute("nombreUsuario", user.getNombreCompleto());
                session.setAttribute("rol", user.getRol());
                session.setAttribute("tipoUsuario", user.getRol());
                
                // Redirigir a inicio
                response.sendRedirect(request.getContextPath() + "/inicio");
            } else {
                // âŒ CREDENCIALES INVÃLIDAS
                request.setAttribute("error", "Usuario o contraseÃ±a incorrectos");
                request.getRequestDispatcher("/WEB-INF/views/login.jsp").forward(request, response);
            }
        } else {
            // ParÃ¡metros faltantes
            response.sendRedirect(request.getContextPath() + "/login");
        }
    }
}
```

### MÃ©todos HTTP y Servlets

| MÃ©todo HTTP | MÃ©todo Servlet | Uso TÃ­pico |
|-------------|----------------|------------|
| **GET** | `doGet()` | Mostrar formularios, listar datos |
| **POST** | `doPost()` | Enviar formularios, crear/actualizar datos |
| **PUT** | `doPut()` | Actualizar recursos (REST API) |
| **DELETE** | `doDelete()` | Eliminar recursos (REST API) |

### Flujo Completo de una PeticiÃ³n

```
1. Usuario escribe en el navegador:
   http://localhost:9000/taller2/login
   
2. GlassFish recibe la peticiÃ³n GET
   â†“
3. Busca el servlet con @WebServlet("/login")
   â†“
4. Llama a LoginServlet.doGet()
   â†“
5. doGet() hace forward a login.jsp
   â†“
6. login.jsp se renderiza y se envÃ­a al navegador
   â†“
7. Usuario completa el formulario y hace clic en "Acceder"
   â†“
8. Navegador envÃ­a POST a /login con datos del formulario
   â†“
9. GlassFish llama a LoginServlet.doPost()
   â†“
10. doPost() valida credenciales con UsuarioDAO
    â†“
11. Si es vÃ¡lido: redirect a /inicio
    Si es invÃ¡lido: forward a login.jsp con mensaje de error
```

---

## ğŸ”‘ SISTEMA DE AUTENTICACIÃ“N {#sistema-autenticaciÃ³n}

### Componentes del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SISTEMA DE AUTENTICACIÃ“N            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. LoginServlet          â†’ Inicio de sesiÃ³n â”‚
â”‚ 2. RegistroServlet       â†’ Crear cuenta     â”‚
â”‚ 3. RecuperarContrasena   â†’ Cambiar password â”‚
â”‚ 4. LogoutServlet         â†’ Cerrar sesiÃ³n    â”‚
â”‚ 5. Filtros de sesiÃ³n     â†’ Proteger rutas   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tipos de Usuario

| Rol | Permisos | Restricciones |
|-----|----------|---------------|
| **INVITADO** | Ver pÃ¡ginas pÃºblicas | âŒ No puede pedir turnos ni comentar |
| **USUARIO** | Pedir turnos, comentar | âŒ No puede acceder al panel |
| **ADMIN** | Gestionar turnos, comentarios, usuarios | âœ… Acceso total |

### Flujo de Registro de Usuario

```java
// RegistroServlet.java - doPost()
@Override
protected void doPost(HttpServletRequest request, HttpServletResponse response) 
        throws ServletException, IOException {
    
    // 1. OBTENER DATOS DEL FORMULARIO
    String nombreCompleto = request.getParameter("nombreCompleto");
    String usuario = request.getParameter("usuario");
    String email = request.getParameter("email");
    String contrasena = request.getParameter("contrasena");
    String confirmarContrasena = request.getParameter("confirmarContrasena");
    
    // 2. VALIDAR QUE LAS CONTRASEÃ‘AS COINCIDAN
    if (!contrasena.equals(confirmarContrasena)) {
        request.setAttribute("error", "Las contraseÃ±as no coinciden");
        request.getRequestDispatcher("/WEB-INF/views/registro.jsp")
               .forward(request, response);
        return;
    }
    
    // 3. VERIFICAR SI EL USUARIO YA EXISTE
    Usuario usuarioExistente = usuarioDAO.buscarPorNombreUsuario(usuario);
    if (usuarioExistente != null) {
        request.setAttribute("error", "El nombre de usuario ya estÃ¡ en uso");
        request.getRequestDispatcher("/WEB-INF/views/registro.jsp")
               .forward(request, response);
        return;
    }
    
    // 4. CREAR NUEVO USUARIO CON ROL USUARIO
    Usuario nuevoUsuario = new Usuario();
    nuevoUsuario.setNombreCompleto(nombreCompleto);
    nuevoUsuario.setUsuario(usuario);
    nuevoUsuario.setEmail(email);
    nuevoUsuario.setContrasena(contrasena);
    nuevoUsuario.setRol("USUARIO");
    nuevoUsuario.setActivo(true);
    
    // 5. GUARDAR EN LA BASE DE DATOS
    boolean registrado = usuarioDAO.crear(nuevoUsuario);
    
    // 6. REDIRIGIR SEGÃšN RESULTADO
    if (registrado) {
        request.setAttribute("exito", "Â¡Registro exitoso! Ya puedes iniciar sesiÃ³n");
        request.getRequestDispatcher("/WEB-INF/views/login.jsp")
               .forward(request, response);
    } else {
        request.setAttribute("error", "Error al registrar el usuario");
        request.getRequestDispatcher("/WEB-INF/views/registro.jsp")
               .forward(request, response);
    }
}
```

### Manejo de Sesiones

```java
// CREAR O OBTENER SESIÃ“N
HttpSession session = request.getSession(); // Crea si no existe

// GUARDAR DATOS EN LA SESIÃ“N
session.setAttribute("usuarioId", user.getId());
session.setAttribute("rol", user.getRol());

// LEER DATOS DE LA SESIÃ“N
Integer usuarioId = (Integer) session.getAttribute("usuarioId");
String rol = (String) session.getAttribute("rol");

// VERIFICAR SI EL USUARIO ESTÃ LOGUEADO
if (session.getAttribute("usuarioId") == null) {
    response.sendRedirect(request.getContextPath() + "/login");
    return;
}

// CERRAR SESIÃ“N
session.invalidate(); // Destruye la sesiÃ³n completa
```

### ProtecciÃ³n de Rutas en JSP

```jsp
<!-- Bloquear acceso a invitados en pedirTurno.jsp -->
<% 
String tipoUsuario = (String) session.getAttribute("tipoUsuario");
if ("INVITADO".equals(tipoUsuario)) {
%>
    <div class="mensaje-bloqueado">
        <i class="fas fa-lock"></i>
        <h2>Acceso Restringido</h2>
        <p>Para pedir un turno debes iniciar sesiÃ³n</p>
        <a href="${pageContext.request.contextPath}/login">Iniciar SesiÃ³n</a>
    </div>
<%
    return; // Detener renderizado del formulario
}
%>

<!-- Bloquear acceso al panel para no-admins -->
<% 
String rol = (String) session.getAttribute("rol");
if (!"ADMIN".equals(rol)) {
    response.sendRedirect(request.getContextPath() + "/inicio");
    return;
}
%>
```

---

## ğŸ“… SISTEMA DE TURNOS Y COMENTARIOS {#turnos-comentarios}

### Modelo de Datos

#### Tabla `turnos`

```sql
CREATE TABLE turnos (
    id SERIAL PRIMARY KEY,
    usuario_id INTEGER REFERENCES usuarios(id),
    servicio_id INTEGER,
    fecha_turno DATE NOT NULL,
    hora_turno TIME NOT NULL,
    nombre_paciente VARCHAR(100) NOT NULL,
    rut VARCHAR(12) NOT NULL,
    telefono VARCHAR(15) NOT NULL,
    email VARCHAR(100) NOT NULL,
    comentarios TEXT,
    estado VARCHAR(20) DEFAULT 'PENDIENTE' 
           CHECK (estado IN ('PENDIENTE', 'CONFIRMADO', 'CANCELADO', 'COMPLETADO')),
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Tabla `comentarios`

```sql
CREATE TABLE comentarios (
    id SERIAL PRIMARY KEY,
    usuario_id INTEGER REFERENCES usuarios(id),
    nombre VARCHAR(100) NOT NULL,
    comentario TEXT NOT NULL,
    calificacion INTEGER CHECK (calificacion BETWEEN 1 AND 5),
    aprobado BOOLEAN DEFAULT FALSE,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Flujo: Crear Turno

```
USUARIO â†’ Formulario pedirTurno.jsp
         â†“
         POST /pedirTurno
         â†“
    PedirTurnoServlet.doPost()
         â†“
    1. Validar sesiÃ³n (no invitado)
    2. Obtener datos del formulario
    3. Crear objeto Turno
    4. turnoDAO.crear(turno)
         â†“
    TurnoDAO.crear()
         â†“
    INSERT INTO turnos (...) VALUES (...)
         â†“
    BD PostgreSQL
         â†“
    Redirect a /pedirTurno con mensaje de Ã©xito
```

### CÃ³digo: `PedirTurnoServlet.java`

```java
@WebServlet("/pedirTurno")
public class PedirTurnoServlet extends HttpServlet {
    
    private TurnoDAO turnoDAO;
    
    @Override
    public void init() {
        turnoDAO = new TurnoDAO();
    }
    
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        HttpSession session = request.getSession();
        
        // 1. VALIDAR QUE NO SEA INVITADO
        String tipoUsuario = (String) session.getAttribute("tipoUsuario");
        if ("INVITADO".equals(tipoUsuario)) {
            session.setAttribute("mensajeError", "Los invitados no pueden pedir turnos");
            response.sendRedirect(request.getContextPath() + "/pedirTurno");
            return;
        }
        
        // 2. OBTENER DATOS DEL FORMULARIO
        Integer usuarioId = (Integer) session.getAttribute("usuarioId");
        String nombrePaciente = request.getParameter("nombre");
        String rut = request.getParameter("rut");
        String telefono = request.getParameter("telefono");
        String email = request.getParameter("email");
        String servicioIdStr = request.getParameter("servicio");
        String fechaStr = request.getParameter("fecha");
        String horaStr = request.getParameter("horario");
        String comentarios = request.getParameter("mensaje");
        
        // 3. CREAR OBJETO TURNO
        Turno turno = new Turno();
        turno.setUsuarioId(usuarioId);
        turno.setServicioId(Integer.parseInt(servicioIdStr));
        turno.setFechaTurno(Date.valueOf(fechaStr));
        turno.setHoraTurno(Time.valueOf(horaStr + ":00"));
        turno.setNombrePaciente(nombrePaciente);
        turno.setRut(rut);
        turno.setTelefono(telefono);
        turno.setEmail(email);
        turno.setComentarios(comentarios);
        turno.setEstado("PENDIENTE");
        
        // 4. GUARDAR EN BD
        boolean creado = turnoDAO.crear(turno);
        
        // 5. MENSAJE DE RETROALIMENTACIÃ“N
        if (creado) {
            session.setAttribute("mensajeExito", "Â¡Turno solicitado exitosamente!");
        } else {
            session.setAttribute("mensajeError", "Error al solicitar el turno");
        }
        
        response.sendRedirect(request.getContextPath() + "/pedirTurno");
    }
}
```

### Flujo: Aprobar Comentario

```
ADMIN â†’ Panel /panel
        â†“
    Ve comentario pendiente
        â†“
    Clic en "Aprobar"
        â†“
    POST /panel/accion
        tipo=comentario, id=1, accion=aprobar
        â†“
    PanelAccionServlet.doPost()
        â†“
    comentarioDAO.aprobar(id)
        â†“
    UPDATE comentarios SET aprobado = TRUE WHERE id = ?
        â†“
    BD PostgreSQL
        â†“
    Redirect a /panel
        â†“
    Comentario aparece en inicio.jsp y contacto.jsp
```

---

## ğŸ›ï¸ PANEL DE ADMINISTRACIÃ“N {#panel-admin}

### Funcionalidades

1. **GestiÃ³n de Usuarios**: Ver lista de usuarios registrados
2. **GestiÃ³n de Turnos**: Aprobar, rechazar, eliminar turnos
3. **GestiÃ³n de Comentarios**: Aprobar, eliminar comentarios

### CÃ³digo: `PanelGestionServlet.java`

```java
@WebServlet("/panel")
public class PanelGestionServlet extends HttpServlet {
    
    private UsuarioDAO usuarioDAO;
    private TurnoDAO turnoDAO;
    private ComentarioDAO comentarioDAO;
    
    @Override
    public void init() {
        usuarioDAO = new UsuarioDAO();
        turnoDAO = new TurnoDAO();
        comentarioDAO = new ComentarioDAO();
    }
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        HttpSession session = request.getSession();
        
        // 1. VALIDAR QUE ESTÃ‰ LOGUEADO
        if (session == null || session.getAttribute("usuarioId") == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }
        
        // 2. VALIDAR QUE SEA ADMIN
        String rol = (String) session.getAttribute("rol");
        if (!"ADMIN".equals(rol)) {
            response.sendRedirect(request.getContextPath() + "/inicio");
            return;
        }
        
        // 3. CARGAR DATOS DESDE LA BD
        List<Usuario> usuarios = usuarioDAO.obtenerTodos();
        List<Turno> turnos = turnoDAO.obtenerTodos();
        List<Comentario> comentarios = comentarioDAO.obtenerTodos();
        
        // 4. PASAR DATOS A LA VISTA
        request.setAttribute("usuarios", usuarios);
        request.setAttribute("turnos", turnos);
        request.setAttribute("comentarios", comentarios);
        
        // 5. MOSTRAR LA VISTA
        request.getRequestDispatcher("/WEB-INF/views/panel.jsp")
               .forward(request, response);
    }
}
```

### CÃ³digo: `PanelAccionServlet.java`

```java
@WebServlet("/panel/accion")
public class PanelAccionServlet extends HttpServlet {
    
    private TurnoDAO turnoDAO;
    private ComentarioDAO comentarioDAO;
    
    @Override
    public void init() {
        turnoDAO = new TurnoDAO();
        comentarioDAO = new ComentarioDAO();
    }
    
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // 1. OBTENER PARÃMETROS
        String tipo = request.getParameter("tipo");       // "turno" o "comentario"
        String idStr = request.getParameter("id");        // ID del registro
        String accion = request.getParameter("accion");   // "aprobar", "rechazar", "eliminar"
        
        int id = Integer.parseInt(idStr);
        boolean exito = false;
        
        // 2. EJECUTAR ACCIÃ“N SEGÃšN TIPO
        if ("turno".equals(tipo)) {
            if ("aprobar".equals(accion)) {
                exito = turnoDAO.actualizarEstado(id, "CONFIRMADO");
            } else if ("rechazar".equals(accion)) {
                exito = turnoDAO.actualizarEstado(id, "CANCELADO");
            } else if ("eliminar".equals(accion)) {
                exito = turnoDAO.eliminar(id);
            }
        } else if ("comentario".equals(tipo)) {
            if ("aprobar".equals(accion)) {
                exito = comentarioDAO.aprobar(id);
            } else if ("eliminar".equals(accion)) {
                exito = comentarioDAO.eliminar(id);
            }
        }
        
        // 3. REDIRIGIR AL PANEL
        response.sendRedirect(request.getContextPath() + "/panel");
    }
}
```

### Interfaz del Panel (panel.jsp)

```jsp
<!-- Tabla de Turnos -->
<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Paciente</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        <% 
        List<Turno> turnos = (List<Turno>) request.getAttribute("turnos");
        if (turnos != null && !turnos.isEmpty()) {
            for (Turno t : turnos) {
        %>
        <tr>
            <td><%= t.getId() %></td>
            <td><%= t.getNombrePaciente() %></td>
            <td><%= t.getFechaTurno() %></td>
            <td><span class="badge badge-<%= t.getEstado().toLowerCase() %>">
                <%= t.getEstado() %>
            </span></td>
            <td>
                <% if ("PENDIENTE".equals(t.getEstado())) { %>
                    <!-- Formulario para APROBAR -->
                    <form method="POST" action="${pageContext.request.contextPath}/panel/accion" style="display:inline;">
                        <input type="hidden" name="tipo" value="turno">
                        <input type="hidden" name="id" value="<%= t.getId() %>">
                        <input type="hidden" name="accion" value="aprobar">
                        <button type="submit" class="btn-aprobar">âœ“ Aprobar</button>
                    </form>
                    
                    <!-- Formulario para RECHAZAR -->
                    <form method="POST" action="${pageContext.request.contextPath}/panel/accion" style="display:inline;">
                        <input type="hidden" name="tipo" value="turno">
                        <input type="hidden" name="id" value="<%= t.getId() %>">
                        <input type="hidden" name="accion" value="rechazar">
                        <button type="submit" class="btn-rechazar">âœ— Rechazar</button>
                    </form>
                <% } %>
                
                <!-- Formulario para ELIMINAR -->
                <form method="POST" action="${pageContext.request.contextPath}/panel/accion" style="display:inline;">
                    <input type="hidden" name="tipo" value="turno">
                    <input type="hidden" name="id" value="<%= t.getId() %>">
                    <input type="hidden" name="accion" value="eliminar">
                    <button type="submit" class="btn-eliminar">ğŸ—‘ Eliminar</button>
                </form>
            </td>
        </tr>
        <% 
            }
        }
        %>
    </tbody>
</table>
```

---

## ğŸ”„ FLUJO DE DATOS COMPLETO {#flujo-datos}

### Caso de Uso: Usuario Solicita Turno

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FLUJO COMPLETO                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. INICIO
   Usuario abre navegador â†’ http://localhost:9000/taller2/inicio

2. NAVEGACIÃ“N
   Usuario ve botÃ³n "Pedir Turno" â†’ Clic
   â†“
   GET /pedirTurno
   â†“
   PagesController.doGet()
   â†“
   Forward a pedirTurno.jsp
   â†“
   JSP verifica sesiÃ³n:
   - Si es INVITADO â†’ Muestra "Acceso Restringido"
   - Si es USUARIO/ADMIN â†’ Muestra formulario

3. COMPLETAR FORMULARIO
   Usuario llena:
   - Nombre: "Juan PÃ©rez"
   - RUT: "12345678-9"
   - TelÃ©fono: "56912345678"
   - Email: "juan@test.cl"
   - Servicio: "Ortodoncia"
   - Fecha: "2025-11-20"
   - Horario: "10:00"
   - Mensaje: "Primera consulta"
   â†“
   Clic en "Solicitar Turno"

4. ENVÃO DE DATOS
   POST /pedirTurno
   Body: nombre=Juan+PÃ©rez&rut=12345678-9&...
   â†“
   PedirTurnoServlet.doPost()

5. VALIDACIÃ“N EN SERVLET
   - Verificar que no sea invitado âœ…
   - Obtener usuarioId de la sesiÃ³n âœ…
   - Parsear fecha y hora âœ…
   - Crear objeto Turno âœ…

6. PERSISTENCIA EN BD
   turnoDAO.crear(turno)
   â†“
   TurnoDAO.crear()
   â†“
   DatabaseConnection.getInstance().getConnection()
   â†“
   PreparedStatement con SQL:
   INSERT INTO turnos 
   (usuario_id, servicio_id, fecha_turno, hora_turno, 
    nombre_paciente, rut, telefono, email, comentarios, estado)
   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'PENDIENTE')
   â†“
   PostgreSQL ejecuta INSERT
   â†“
   Retorna true si Ã©xito

7. RETROALIMENTACIÃ“N
   session.setAttribute("mensajeExito", "Â¡Turno solicitado!")
   â†“
   response.sendRedirect("/pedirTurno")
   â†“
   pedirTurno.jsp muestra mensaje verde:
   "âœ“ Â¡Turno solicitado exitosamente!"

8. GESTIÃ“N POR ADMIN
   Admin abre â†’ http://localhost:9000/taller2/panel
   â†“
   GET /panel
   â†“
   PanelGestionServlet.doGet()
   â†“
   turnoDAO.obtenerTodos()
   â†“
   SELECT * FROM turnos ORDER BY fecha_turno, hora_turno
   â†“
   PostgreSQL retorna lista de turnos
   â†“
   panel.jsp renderiza tabla con turno de Juan PÃ©rez
   â†“
   Admin ve botones: [âœ“ Aprobar] [âœ— Rechazar] [ğŸ—‘ Eliminar]

9. APROBACIÃ“N
   Admin hace clic en "Aprobar"
   â†“
   POST /panel/accion
   Body: tipo=turno&id=1&accion=aprobar
   â†“
   PanelAccionServlet.doPost()
   â†“
   turnoDAO.actualizarEstado(1, "CONFIRMADO")
   â†“
   UPDATE turnos SET estado = 'CONFIRMADO' WHERE id = 1
   â†“
   PostgreSQL ejecuta UPDATE
   â†“
   Redirect a /panel
   â†“
   Badge cambia de naranja (PENDIENTE) a verde (CONFIRMADO)

10. FIN
    Turno aprobado y visible para el usuario
```

### Diagrama de Secuencia

```
Usuario          PedirTurno     TurnoDAO      DatabaseConn    PostgreSQL
  â”‚                 â”‚              â”‚               â”‚              â”‚
  â”œâ”€POST /pedirTurnoâ†’â”‚              â”‚               â”‚              â”‚
  â”‚                 â”œâ”€crear(turno)â†’â”‚               â”‚              â”‚
  â”‚                 â”‚              â”œâ”€getConnection()â†’              â”‚
  â”‚                 â”‚              â”‚               â”œâ”€return conn â†’â”‚
  â”‚                 â”‚              â”œâ”€prepareStatement()â†’           â”‚
  â”‚                 â”‚              â”œâ”€setString()...â”€â†’              â”‚
  â”‚                 â”‚              â”œâ”€executeUpdate()â†’              â”‚
  â”‚                 â”‚              â”‚               â”‚              â”œâ”€INSERT
  â”‚                 â”‚              â”‚               â”‚              â”œâ”€return 1
  â”‚                 â”‚              â”œâ”€return trueâ”€â”€â†â”‚              â”‚
  â”‚                 â”œâ”€return trueâ†â”€â”‚               â”‚              â”‚
  â”‚                 â”œâ”€setAttribute("mensajeExito")  â”‚              â”‚
  â”‚                 â”œâ”€sendRedirect("/pedirTurno")  â”‚              â”‚
  â”œâ”€HTTP 302â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚              â”‚
  â”œâ”€GET /pedirTurnoâ†’â”‚              â”‚               â”‚              â”‚
  â”œâ”€Muestra mensaje verde          â”‚               â”‚              â”‚
```

---

## ğŸ“Š RESUMEN DE TECNOLOGÃAS Y PATRONES

### Stack TecnolÃ³gico

| Capa | TecnologÃ­a | VersiÃ³n |
|------|------------|---------|
| **Frontend** | JSP + CSS + JavaScript | Jakarta EE 9 |
| **Backend** | Java (Servlets) | Java 11 |
| **Base de Datos** | PostgreSQL | 13+ |
| **Servidor de Aplicaciones** | GlassFish | 6.2.5 |
| **Build Tool** | Maven | 3.8.7 |
| **JDBC Driver** | PostgreSQL JDBC Driver | 42.6.0 |

### Patrones de DiseÃ±o Utilizados

1. **Singleton**: `DatabaseConnection.java`
   - Una Ãºnica instancia de conexiÃ³n a BD
   - Thread-safe con double-check locking

2. **DAO (Data Access Object)**: `UsuarioDAO`, `TurnoDAO`, `ComentarioDAO`
   - Encapsula toda la lÃ³gica de acceso a datos
   - Separa SQL de la lÃ³gica de negocio

3. **MVC (Model-View-Controller)**:
   - **Model**: `Usuario.java`, `Turno.java`, `Comentario.java`
   - **View**: JSP files (`login.jsp`, `panel.jsp`, etc.)
   - **Controller**: Servlets (`LoginServlet`, `PanelGestionServlet`, etc.)

4. **Front Controller**: `PagesController.java`
   - Maneja rutas estÃ¡ticas (`/inicio`, `/servicios`, etc.)
   - Centraliza la lÃ³gica de navegaciÃ³n

5. **Session Management**: HttpSession
   - Mantiene el estado del usuario
   - Almacena datos entre peticiones

### Convenciones y Buenas PrÃ¡cticas

#### Nomenclatura

```java
// Clases: PascalCase
public class UsuarioDAO { }

// MÃ©todos: camelCase
public Usuario autenticar(String usuario, String contrasena) { }

// Constantes: UPPER_SNAKE_CASE
private static final String DB_URL = "jdbc:postgresql://...";

// Variables: camelCase
String nombreUsuario = "Subaru";
```

#### Manejo de Recursos

```java
// âœ… CORRECTO: Try-with-resources (cierra automÃ¡ticamente)
try (Connection conn = DatabaseConnection.getInstance().getConnection();
     PreparedStatement stmt = conn.prepareStatement(sql)) {
    // cÃ³digo
} catch (SQLException e) {
    e.printStackTrace();
}

// âŒ INCORRECTO: Cierre manual (puede olvidarse)
Connection conn = null;
PreparedStatement stmt = null;
try {
    conn = DatabaseConnection.getInstance().getConnection();
    stmt = conn.prepareStatement(sql);
    // cÃ³digo
} finally {
    if (stmt != null) stmt.close();
    if (conn != null) conn.close();
}
```

#### PrevenciÃ³n de SQL Injection

```java
// âœ… CORRECTO: PreparedStatement con parÃ¡metros
String sql = "SELECT * FROM usuarios WHERE usuario = ? AND contrasena = ?";
PreparedStatement stmt = conn.prepareStatement(sql);
stmt.setString(1, usuario);
stmt.setString(2, contrasena);

// âŒ INCORRECTO: ConcatenaciÃ³n de strings
String sql = "SELECT * FROM usuarios WHERE usuario = '" + usuario + 
             "' AND contrasena = '" + contrasena + "'";
// Vulnerable a: usuario' OR '1'='1
```

---

## ğŸš€ GUÃA DE DESPLIEGUE

### Requisitos del Sistema

- **Java JDK**: 11 o superior
- **PostgreSQL**: 13 o superior
- **GlassFish**: 6.2.5
- **Maven**: 3.8.7 o superior

### Pasos de InstalaciÃ³n

#### 1. Configurar Base de Datos

```sql
-- Conectarse a PostgreSQL
psql -U postgres

-- Crear base de datos
CREATE DATABASE taller2_bd;

-- Conectarse a la BD
\c taller2_bd

-- Ejecutar script de creaciÃ³n de tablas
\i /path/to/create_database.sql
```

#### 2. Compilar Proyecto

```bash
cd /path/to/Taller2

# Establecer JAVA_HOME
export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64

# Compilar con Maven
mvn clean package
```

#### 3. Desplegar en GlassFish

```bash
# Iniciar GlassFish
asadmin start-domain

# Desplegar aplicaciÃ³n
asadmin deploy --force true /path/to/Taller2/target/taller2.war

# Verificar despliegue
asadmin list-applications
```

#### 4. Acceder a la AplicaciÃ³n

```
URL: http://localhost:9000/taller2/inicio

Usuarios de prueba:
- Admin: Subaru / admin123
- Usuario: Blas / user123
- Invitado: Clic en "Acceder como invitado"
```

---

## ğŸ› SOLUCIÃ“N DE PROBLEMAS COMUNES

### Error: "Cannot find PostgreSQL Driver"

```bash
# Verificar que el driver estÃ© en pom.xml
<dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
    <version>42.6.0</version>
</dependency>

# Recompilar
mvn clean package
```

### Error: "Port 9000 already in use"

```bash
# Detener GlassFish
asadmin stop-domain

# Cambiar puerto en domain.xml o matar proceso
sudo lsof -i :9000
sudo kill -9 <PID>

# Reiniciar
asadmin start-domain
```

### Error: "Connection refused to PostgreSQL"

```bash
# Verificar que PostgreSQL estÃ© corriendo
sudo systemctl status postgresql

# Iniciar si estÃ¡ detenido
sudo systemctl start postgresql

# Verificar puerto (por defecto 5432)
sudo netstat -plunt | grep postgres
```

### Error: "Class file has wrong version 65.0"

```bash
# Significa que se compilÃ³ con Java 21 pero GlassFish usa Java 11

# SoluciÃ³n: Compilar con Java 11
export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
mvn clean package

# Verificar versiÃ³n compilada
javap -v target/classes/com/taller2/controller/LoginServlet.class | grep "major version"
# Debe mostrar: major version: 55 (Java 11)
```

---

## ğŸ“š GLOSARIO DE TÃ‰RMINOS

| TÃ©rmino | DefiniciÃ³n |
|---------|------------|
| **Servlet** | Clase Java que maneja peticiones HTTP y genera respuestas dinÃ¡micas |
| **JSP** | JavaServer Pages - TecnologÃ­a para crear pÃ¡ginas web dinÃ¡micas con Java |
| **DAO** | Data Access Object - PatrÃ³n que encapsula acceso a datos |
| **Singleton** | PatrÃ³n que garantiza una Ãºnica instancia de una clase |
| **POJO** | Plain Old Java Object - Objeto Java simple sin herencia especial |
| **PreparedStatement** | Sentencia SQL precompilada con parÃ¡metros (previene SQL Injection) |
| **HttpSession** | Objeto que mantiene datos del usuario entre peticiones |
| **Forward** | Transferir peticiÃ³n a otro recurso en el servidor (misma URL) |
| **Redirect** | Indicar al navegador que vaya a otra URL (cambia URL) |
| **JDBC** | Java Database Connectivity - API para conectarse a bases de datos |
| **Try-with-resources** | Sintaxis Java que cierra recursos automÃ¡ticamente |
| **MVC** | Model-View-Controller - PatrÃ³n arquitectÃ³nico de separaciÃ³n de capas |

---

## ğŸ“ CONCEPTOS CLAVE EXPLICADOS

### Â¿Por quÃ© separar en capas?

```
SIN CAPAS (todo en un servlet):
âŒ DifÃ­cil de mantener
âŒ CÃ³digo duplicado
âŒ SQL mezclado con HTML
âŒ DifÃ­cil de testear

CON CAPAS (MVC + DAO):
âœ… FÃ¡cil de mantener (cada capa tiene una responsabilidad)
âœ… ReutilizaciÃ³n (un DAO se usa en mÃºltiples servlets)
âœ… SQL separado en DAOs
âœ… FÃ¡cil de testear (mock de DAOs)
```

### Â¿Por quÃ© usar PreparedStatement?

```java
// EJEMPLO DE SQL INJECTION

// Usuario malicioso escribe en el formulario:
// Usuario: admin' OR '1'='1
// ContraseÃ±a: cualquier cosa

// Con concatenaciÃ³n (VULNERABLE):
String sql = "SELECT * FROM usuarios WHERE usuario = '" + usuario + 
             "' AND contrasena = '" + contrasena + "'";
// Resultado: SELECT * FROM usuarios WHERE usuario = 'admin' OR '1'='1' AND contrasena = 'cualquier cosa'
// Â¡'1'='1' siempre es verdadero! â†’ Login sin contraseÃ±a âŒ

// Con PreparedStatement (SEGURO):
String sql = "SELECT * FROM usuarios WHERE usuario = ? AND contrasena = ?";
PreparedStatement stmt = conn.prepareStatement(sql);
stmt.setString(1, "admin' OR '1'='1"); // Se escapa automÃ¡ticamente
stmt.setString(2, "cualquier cosa");
// Resultado: Busca literalmente el usuario "admin' OR '1'='1" â†’ No existe âœ…
```

### Forward vs Redirect

```java
// FORWARD (misma peticiÃ³n, misma URL)
request.getRequestDispatcher("/WEB-INF/views/login.jsp").forward(request, response);
// URL en navegador: http://localhost:9000/taller2/login
// Se ejecuta en el servidor, el navegador no sabe
// Los atributos del request se mantienen

// REDIRECT (nueva peticiÃ³n, nueva URL)
response.sendRedirect(request.getContextPath() + "/inicio");
// URL en navegador: http://localhost:9000/taller2/inicio
// El navegador hace una nueva peticiÃ³n GET
// Los atributos del request se pierden (usar session)
```

### Session vs Request Attributes

```java
// REQUEST ATTRIBUTE (solo para la peticiÃ³n actual)
request.setAttribute("error", "Usuario no encontrado");
// Disponible en: mismo request, forward a JSP
// Se pierde en: redirect

// SESSION ATTRIBUTE (persiste entre peticiones)
session.setAttribute("usuarioId", user.getId());
// Disponible en: todas las peticiones mientras la sesiÃ³n estÃ© activa
// Se mantiene en: redirect, forward, nuevas peticiones
// Se pierde en: session.invalidate() o timeout
```

---

## ğŸ“ CONCLUSIÃ“N

Este sistema demuestra la implementaciÃ³n de:

1. **PatrÃ³n Singleton** para gestiÃ³n eficiente de conexiones a BD
2. **PatrÃ³n DAO** para separaciÃ³n de lÃ³gica de acceso a datos
3. **Arquitectura MVC** con Servlets (Controller), JSP (View) y POJOs (Model)
4. **Sistema de autenticaciÃ³n robusto** con roles y protecciÃ³n de rutas
5. **GestiÃ³n de turnos y comentarios** con workflow de aprobaciÃ³n
6. **Panel administrativo** para gestiÃ³n centralizada

### Ventajas de esta Arquitectura

- âœ… **Escalable**: FÃ¡cil agregar nuevas funcionalidades
- âœ… **Mantenible**: CÃ³digo organizado por responsabilidades
- âœ… **Seguro**: PrevenciÃ³n de SQL Injection, validaciÃ³n de sesiones
- âœ… **Reutilizable**: DAOs y utilidades se comparten entre componentes
- âœ… **Profesional**: Sigue estÃ¡ndares de la industria (Jakarta EE)

---

**Autor:** Equipo de Desarrollo Taller2  
**Fecha de CreaciÃ³n:** Noviembre 2025  
**Ãšltima ActualizaciÃ³n:** 17 de noviembre de 2025  
**VersiÃ³n:** 1.0
